#
# This file allows to:
#   - create a ruby docker environment for development
#   - run a testsuite from scratch like .travis.yml
#
# Run all tests with
#
# $ docker-compose up test
#
# Create the develompent environment with
#
# $ docker-compose up -d ruby
# $ docker exec -ti fogopenstack_ruby_1  /bin/bash
#
version: '2'

services:

  ruby:
    image: ruby:2.4-stretch
    cap_add:
    - SYS_PTRACE
    volumes:
    - .:/code:z
    - .:/home/travis/build/fog/fog-openstack:z
    entrypoint: tail -f /etc/hosts

  test:
    image: ruby:2.4-stretch
    cap_add:
    - SYS_PTRACE
    volumes:
    - .:/code:z
    - .:/home/travis/build/fog/fog-openstack:z
    environment:
    - JRUBY_OPTS=--debug
    working_dir: /home/travis/build/fog/fog-openstack
    entrypoint: |
      bash -c '
        gem update bundler --verbose
        bundle install --verbose
        bundle exec rake test
        bundle exec rake spec
        '

  devstack.openstack.stack:
    image: devstack.openstack.stack
    build:
      context: devstack.openstack.stack
      dockerfile: Dockerfile
    cap_add:
      - NET_ADMIN
    volumes:
      - ./devstack.openstack.stack:/code:z
    entrypoint: bash

  test-build:
    image: ruby:3.0
    depends_on:
      - "devstack.openstack.stack"
    volumes:
      - .:/code:z
      - .:/home/travis/build/fog/fog-openstack:z
    working_dir: /home/travis/build/fog/fog-openstack
    entrypoint: |
      bash -c '
        apt install wait-for-it
        gem update bundler --verbose
        bundle install --verbose
        rm -fr spec/fixtures/openstack
        wait-for-it.sh -t 60 devstack.openstack.stack:5000
        bundle exec rake spec
        '
